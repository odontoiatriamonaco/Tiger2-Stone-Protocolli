<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Protocollo IDI Evolution (Tiger 2 & Stone)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root {
    --accent: #008080; /* Un colore teal/verde ottanio per differenziarlo dal B1One */
    --light-bg: #f0f8f8;
    --white: #ffffff;
    --gray: #dfe4ea;
    --font: 'Segoe UI', 'Roboto', sans-serif;
  }
  body {
    font-family: var(--font);
    margin: 0;
    padding: 10px;
    background: var(--light-bg);
    color: #333;
    max-width: 100%;
    padding-bottom: 80px;
  }
  /* Overlay Password */
  #password-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(5px);
  }
  #password-box {
    background: white;
    padding: 30px 40px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    width: 90%;
    max-width: 350px;
  }
  #password-box h2 { margin-top: 0; color: var(--accent); }
  #password-input {
    width: 100%; padding: 10px; margin: 15px 0;
    border: 1px solid var(--gray); border-radius: 6px; font-size: 16px; box-sizing: border-box;
  }
  #password-box button { width: 100%; background-color: var(--accent); color: white; }

  /* Modal Info Tecnica */
  #tech-modal {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 10001;
    align-items: center; justify-content: center;
  }
  #tech-content {
    background: white;
    width: 90%; max-width: 500px;
    border-radius: 10px;
    padding: 25px;
    position: relative;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  #tech-close {
    position: absolute; top: 10px; right: 15px;
    font-size: 24px; cursor: pointer; color: #666;
  }
  .tech-detail-row {
      display: flex; justify-content: space-between;
      border-bottom: 1px solid #eee; padding: 8px 0;
  }
  .tech-detail-label { font-weight: bold; color: #555; }

  /* Badge Dedotto */
  .badge-deduced {
      background-color: #fff3cd;
      color: #856404;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      border: 1px solid #ffeeba;
      display: inline-block;
      margin-bottom: 10px;
      font-weight: bold;
  }

  header {
    background: linear-gradient(90deg, var(--accent), #004d4d);
    color: white;
    padding: 30px 0;
    text-align: center;
    border-bottom: 3px solid #003333;
    border-radius: 0 0 10px 10px;
  }
  header h1 { margin: 0; font-size: 26px; letter-spacing: 1px; text-transform: uppercase; }
  header p { font-size: 14px; margin-top: 5px; opacity: 0.9; }

  .container {
    max-width: 1000px;
    margin: 30px auto;
    padding: 20px 30px;
    background: var(--white);
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.06);
  }
  
  .form-group { margin-bottom: 15px; }
  .form-group label { font-weight: 600; margin-bottom: 6px; display: block; font-size: 14px; }
  .form-group input, .form-group select {
    width: 100%; padding: 10px; margin-top: 4px; margin-bottom: 16px;
    border: 1px solid var(--gray); border-radius: 6px; background: #fafafa; font-size: 16px;
    box-sizing: border-box;
  }

  button {
    padding: 12px; font-size: 16px; font-weight: 600; border: none; border-radius: 6px;
    cursor: pointer; transition: all 0.3s ease; flex: 1;
  }
  button:hover { opacity: 0.9; }
  
  .button-container {
    display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 20px 0;
  }
  .button-container button { flex: 1 1 45%; min-width: 140px; }
  
  #elaboraBtn { background-color: #28a745; color: white; }
  #resetBtn { background-color: #dc3545; color: white; }
  #pdfBtn { background-color: #007bff; color: white; }
  #saveBtn { background-color: #ffc107; color: black; }

  /* Card Impianto */
  .impianto-card {
    background: #fff;
    border-left: 5px solid var(--accent);
    padding: 15px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
  }
  .impianto-header {
    display: flex; justify-content: space-between; align-items: center;
    font-weight: 600; font-size: 16px; margin-bottom: 12px;
    border-bottom: 1px solid #eee; padding-bottom: 5px;
  }
  .collapse-btn {
    background: none; border: none; color: var(--accent); font-size: 22px; cursor: pointer; padding: 0; width: auto; flex: none;
  }

  /* Risultati */
  .result-row {
    background: #f9f9f9; border-left: 4px solid var(--accent);
    padding: 16px 20px; border-radius: 8px; margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .result-block { font-size: 15px; margin-bottom: 8px; line-height: 1.4; }
  .dente { font-weight: bold; font-size: 22px; text-align: center; margin-bottom: 5px; color: var(--accent); }
  .densita { font-weight: bold; font-size: 20px; text-align: center; margin-bottom: 10px; }
  
  .hidden { display: none; }
  
  /* Placeholder Immagini */
  .img-placeholder {
      display: flex; align-items: center; justify-content: center; flex-direction: column;
      background-color: #eee; border: 2px dashed #ccc; color: #777;
      padding: 20px; text-align: center; font-size: 12px; min-height: 150px; border-radius: 8px;
  }

  @media (max-width: 768px) {
    .result-row { display: flex !important; flex-direction: column !important; gap: 10px !important; }
    .result-row > div:nth-child(2) { width: 100% !important; height: 4px !important; }
  }
</style>
</head>
<body>

<!-- PASSWORD -->
<div id="password-overlay">
  <div id="password-box">
    <h2>Accesso Riservato</h2>
    <p>Protocollo IDI Evolution</p>
    <input type="password" id="password-input" placeholder="Password" autofocus>
    <button onclick="checkPassword()">Accedi</button>
  </div>
</div>

<!-- MODAL SCHEDA TECNICA -->
<div id="tech-modal">
  <div id="tech-content">
    <span id="tech-close" onclick="closeTechModal()">&times;</span>
    <h3 id="tech-title" style="color:var(--accent); margin-top:0;">Scheda Tecnica</h3>
    <div id="tech-body">
      <!-- Contenuto dinamico -->
    </div>
  </div>
</div>

<header>
  <h1>Protocollo Chirurgico</h1>
  <p>IDI Evolution: Tiger 2 & Stone</p>
  <p style="font-size:12px; margin-top:5px; color: #ddd;">Strumento di supporto alla pianificazione implantare</p>
</header>

<div class="container">
  <div class="form-group">
    <label for="nome">Paziente (Cognome e Nome):</label>
    <input type="text" id="nome" placeholder="Es. Rossi Mario">
  </div>
  
  <div class="form-group">
    <label for="impianti">Numero di impianti da inserire:</label>
    <select id="impianti" onchange="creaCampiImpianti()">
      <option value="">-- Seleziona --</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>
  </div>

  <div id="impianti-container"></div>

  <div class="button-container">
    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="caricaDati(event)">
    <button onclick="document.getElementById('fileInput').click()" style="background:#6c757d; color:white;">üìÇ Carica Dati</button>
    <button id="saveBtn" onclick="salvaDati()">üíæ Salva</button>
    <button id="elaboraBtn" onclick="elabora()">ELABORA</button>
    <button id="resetBtn" onclick="resetta()">RESET</button>
    <button id="pdfBtn" onclick="esportaPDF()">ESPORTA PDF</button>
  </div>

  <div id="output">
    <p style="text-align: center; color: #777; font-style: italic; margin-top:30px;">
      Compila i campi sopra e premi "ELABORA" per visualizzare il protocollo di fresatura.
    </p>
  </div>
</div>

<!-- Footer Fisso -->
<div style="position: fixed; bottom: 10px; right: 10px; z-index: 999;">
  <button onclick="alert('Inviare email a odontoiatria.monaco@gmail.com')" style="background-color: #008080; color: white; padding: 8px 14px; border-radius: 30px; font-weight: bold; font-size: 13px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
    üì¨ Contatti
  </button>
</div>

<script>
// --- LOGICA DI ACCESSO ---
function checkPassword() {
  const pwd = document.getElementById('password-input').value;
  if (pwd === "Martina07") { 
    document.getElementById('password-overlay').style.display = 'none';
  } else {
    alert('Password errata.');
    document.getElementById('password-input').value = "";
  }
}
document.getElementById('password-input').addEventListener('keyup', (e) => {
    if (e.key === "Enter") checkPassword();
});

// --- GESTIONE MODAL TECNICO ---
function openTechModal(tipo, diametro) {
    const modal = document.getElementById('tech-modal');
    const title = document.getElementById('tech-title');
    const body = document.getElementById('tech-body');
    
    title.innerText = `Scheda Tecnica: ${tipo} √ò ${diametro}`;
    
    let content = "";
    
    if (tipo === 'Stone') {
        let platformColor = "";
        let bodyDiam = "";
        let platformDiam = "";
        
        // Dati dalla scheda tecnica Stone/Stone TC
        if (diametro === '3.5') { platformColor = "#f1c40f"; bodyDiam = "3.0 mm"; platformDiam = "3.5 mm (Yellow)"; }
        else if (diametro === '3.75') { platformColor = "#3498db"; bodyDiam = "3.2 mm"; platformDiam = "4.0 mm (Blue)"; }
        else if (diametro === '4.0') { platformColor = "#3498db"; bodyDiam = "3.2 mm"; platformDiam = "4.0 mm (Blue)"; }
        else if (diametro === '5.0') { platformColor = "#2ecc71"; bodyDiam = "4.0 mm"; platformDiam = "5.0 mm (Green)"; }
        else if (diametro === '6.0') { platformColor = "#e91e63"; bodyDiam = "5.0 mm"; platformDiam = "6.0 mm (Pink)"; }
        
        content = `
            <div style="margin-bottom:15px; border-left: 4px solid ${platformColor}; padding-left:10px;">
                <p><strong>Caratteristiche:</strong> Inserto alloplastico versatile (ampio spettro minerale).</p>
                <p><strong>Superficie:</strong> Osteorapid (fino a 0.7-1mm dal bordo).</p>
                <p><strong>Collo:</strong> Triplice microfilettatura sincronizzata per stabilit√† corticale.</p>
            </div>
            <div class="tech-detail-row"><span class="tech-detail-label">Diametro Testa (Spire):</span> <span>${diametro} mm</span></div>
            <div class="tech-detail-row"><span class="tech-detail-label">Diametro Corpo:</span> <span>${bodyDiam}</span></div>
            <div class="tech-detail-row"><span class="tech-detail-label">Piattaforma Protesica:</span> <span style="color:${platformColor === '#f1c40f' ? '#d4ac0d' : platformColor}; font-weight:bold;">${platformDiam}</span></div>
        `;
    } else {
        // TIGER 2
        let platformColor = "#3498db"; // Default Blue
        let bodyDiam = "";
        let platformDiam = "4.0 mm (Blue)";
        let headDiam = diametro; // Di base la testa corrisponde al nominale

        // Dati dalla scheda tecnica Tiger 2
        if (diametro === '3.8') { 
            platformColor = "#3498db"; 
            bodyDiam = "3.1 mm"; 
            headDiam = "4.0 mm";
            platformDiam = "4.0 mm (Blue)"; 
        }
        else if (diametro === '4.3') { 
            platformColor = "#3498db"; 
            bodyDiam = "3.6 mm"; 
            headDiam = "4.3 mm";
            platformDiam = "4.0 mm (Blue)"; 
        }
        else if (diametro === '4.8') { 
            platformColor = "#3498db"; 
            bodyDiam = "4.1 mm"; 
            headDiam = "4.8 mm";
            platformDiam = "4.0 mm (Blue)"; 
        }
        else if (diametro === '5.3') { 
            platformColor = "#2ecc71"; 
            bodyDiam = "4.6 mm"; 
            headDiam = "5.3 mm";
            platformDiam = "5.0 mm (Green)"; 
        }

        content = `
            <div style="margin-bottom:15px; border-left: 4px solid ${platformColor}; padding-left:10px;">
                <p><strong>Caratteristiche:</strong> Ideale per osso D3/D4 e siti post-estrattivi (perimetro cilindro-conico).</p>
                <p><strong>Design:</strong> Spiralatura a doppio principio (passo rapido). Spire profonde per massima stabilit√† primaria.</p>
            </div>
            <div class="tech-detail-row"><span class="tech-detail-label">Diametro Testa (Spire):</span> <span>${headDiam}</span></div>
            <div class="tech-detail-row"><span class="tech-detail-label">Diametro Corpo:</span> <span>${bodyDiam}</span></div>
            <div class="tech-detail-row"><span class="tech-detail-label">Piattaforma Protesica:</span> <span style="color:${platformColor === '#2ecc71' ? '#27ae60' : platformColor}; font-weight:bold;">${platformDiam}</span></div>
        `;
    }
    
    body.innerHTML = content;
    modal.style.display = 'flex';
}

function closeTechModal() {
    document.getElementById('tech-modal').style.display = 'none';
}

// --- GENERAZIONE INTERFACCIA DINAMICA ---
function creaCampiImpianti() {
  const num = document.getElementById('impianti').value;
  const container = document.getElementById('impianti-container');
  container.innerHTML = '';
  if (!num) return;

  for (let i = 0; i < num; i++) {
    const card = document.createElement('div');
    card.className = 'impianto-card';
    
    // HTML della card
    card.innerHTML = `
      <div class="impianto-header">
        <span>Impianto ${i + 1}</span>
        <button class="collapse-btn" onclick="toggleCard(this)">‚àí</button>
      </div>
      <div class="impianto-content">
        <!-- DENTE -->
        <div class="form-group">
          <label>Posizione (Dente):</label>
          <select id="dente_${i}">
            <option value="">-- Seleziona --</option>
            ${[11,12,13,14,15,16,17,18,21,22,23,24,25,26,27,28,31,32,33,34,35,36,37,38,41,42,43,44,45,46,47,48].map(n => `<option value="${n}">${n}</option>`).join('')}
          </select>
        </div>

        <!-- DENSIT√Ä -->
        <div class="form-group">
          <label>Densit√† Ossea (HU o Classe):</label>
          <div style="display:flex; gap:10px; margin-bottom:10px;">
             <label><input type="radio" name="mode_${i}" value="hu" checked onclick="toggleInputMode(${i})"> Hounsfield</label>
             <label><input type="radio" name="mode_${i}" value="class" onclick="toggleInputMode(${i})"> Classe (D1-D4)</label>
          </div>
          <input type="number" id="hu_${i}" placeholder="Valore HU (es. 850)">
          <select id="class_${i}" style="display:none;" onchange="syncHuFromClass(${i})">
            <option value="">-- Seleziona Classe --</option>
            <option value="D1">D1 (>1250 HU)</option>
            <option value="D2">D2 (850-1250 HU)</option>
            <option value="D3">D3 (350-850 HU)</option>
            <option value="D4">D4 (<350 HU)</option>
          </select>
        </div>

        <!-- TIPO IMPIANTO (TIGER 2 / STONE) -->
        <div class="form-group">
          <label>Linea Implantare:</label>
          <select id="tipo_${i}" onchange="aggiornaDiametri(${i})">
            <option value="Tiger2">IDI Tiger 2</option>
            <option value="Stone">IDI Stone</option>
          </select>
        </div>

        <!-- DIAMETRO -->
        <div class="form-group">
          <label>Diametro (mm):</label>
          <select id="diametro_${i}" onchange="aggiornaLunghezze(${i})">
            <!-- Popolato via JS -->
          </select>
        </div>

        <!-- LUNGHEZZA -->
        <div class="form-group">
          <label>Lunghezza (mm):</label>
          <select id="lunghezza_${i}">
             <!-- Popolato via JS -->
          </select>
        </div>
        
        <!-- OPZIONI CLINICHE -->
        <div class="form-group" style="display:flex; gap:20px;">
           <div style="flex:1;">
             <label>Post-Estrattivo?</label>
             <select id="post_${i}"><option value="no">No</option><option value="si">S√¨</option></select>
           </div>
           <div style="flex:1;">
             <label>Carico Immediato?</label>
             <select id="carico_${i}"><option value="no">No</option><option value="si">S√¨</option></select>
           </div>
        </div>
      </div>
    `;
    container.appendChild(card);
    // Inizializza i valori per questa card
    aggiornaDiametri(i);
  }
}

function toggleCard(btn) {
  const content = btn.parentNode.nextElementSibling;
  if (content.classList.contains('hidden')) {
    content.classList.remove('hidden');
    btn.textContent = '‚àí';
  } else {
    content.classList.add('hidden');
    btn.textContent = '+';
  }
}

function toggleInputMode(i) {
  const mode = document.querySelector(`input[name="mode_${i}"]:checked`).value;
  const huInput = document.getElementById(`hu_${i}`);
  const classInput = document.getElementById(`class_${i}`);
  
  if (mode === 'hu') {
    huInput.style.display = 'block';
    classInput.style.display = 'none';
  } else {
    huInput.style.display = 'none';
    classInput.style.display = 'block';
  }
}

function syncHuFromClass(i) {
  const val = document.getElementById(`class_${i}`).value;
  const huInput = document.getElementById(`hu_${i}`);
  // Valori medi indicativi per la logica interna se l'utente sceglie la classe
  if(val === 'D1') huInput.value = 1300;
  if(val === 'D2') huInput.value = 1000;
  if(val === 'D3') huInput.value = 600;
  if(val === 'D4') huInput.value = 200;
}

// --- LOGICA DATI IDI EVOLUTION ---

function aggiornaDiametri(i) {
  const tipo = document.getElementById(`tipo_${i}`).value;
  const sel = document.getElementById(`diametro_${i}`);
  // Salva il valore corrente se esiste per tentare di mantenerlo dopo l'aggiornamento
  const currentVal = sel.value;
  
  sel.innerHTML = '';
  
  let opts = [];
  if (tipo === 'Tiger2') {
    // Diametri Tiger 2
    opts = ['3.8', '4.3', '4.8', '5.3'];
  } else {
    // Diametri Stone
    opts = ['3.5', '3.75', '4.0', '5.0', '6.0'];
  }
  
  opts.forEach(d => {
    sel.innerHTML += `<option value="${d}">${d}</option>`;
  });
  
  // Se il valore precedente esiste ancora nella nuova lista, mantienilo
  if (opts.includes(currentVal)) {
      sel.value = currentVal;
  }
  
  aggiornaLunghezze(i);
}

function aggiornaLunghezze(i) {
  const tipo = document.getElementById(`tipo_${i}`).value;
  const diametro = document.getElementById(`diametro_${i}`).value;
  const sel = document.getElementById(`lunghezza_${i}`);
  sel.innerHTML = '';
  
  let lens = [];
  
  if (tipo === 'Tiger2') {
      // LOGICA TIGER 2
      if (['4.8', '5.3'].includes(diametro)) {
          lens = ['8', '10', '12', '14'];
      } else if (['3.8', '4.3'].includes(diametro)) {
          lens = ['8', '10', '12', '14', '15.5', '17'];
      } else {
          lens = ['8', '10', '12', '14']; // Fallback
      }
  } else {
      // LOGICA STONE (Verificata con le immagini)
      if (diametro === '3.5') {
          // √ò 3.5: arriva fino a 15.5 (no 17)
          lens = ['8', '10', '12', '14', '15.5'];
      } else if (['3.75', '4.0'].includes(diametro)) {
          // √ò 3.75 e 4.0: completi fino a 17
          lens = ['8', '10', '12', '14', '15.5', '17'];
      } else if (['5.0', '6.0'].includes(diametro)) {
          // √ò 5.0 e 6.0: solo fino a 14
          lens = ['8', '10', '12', '14'];
      } else {
          // Fallback generico
          lens = ['8', '10', '12', '14'];
      }
  }
  
  lens.forEach(l => {
    sel.innerHTML += `<option value="${l}">${l}</option>`;
  });
}

// --- ELABORAZIONE LOGICA ---

function elabora() {
  const nome = document.getElementById('nome').value;
  const num = document.getElementById('impianti').value;
  
  if (!num) { alert("Seleziona numero impianti"); return; }
  
  let html = `<h2 style="text-align:center;">Protocollo per ${nome || 'Paziente'}</h2>`;
  
  for (let i = 0; i < num; i++) {
    const dente = document.getElementById(`dente_${i}`).value;
    const hu = parseInt(document.getElementById(`hu_${i}`).value);
    const tipo = document.getElementById(`tipo_${i}`).value;
    const diametro = document.getElementById(`diametro_${i}`).value;
    const lungh = document.getElementById(`lunghezza_${i}`).value;
    const carico = document.getElementById(`carico_${i}`).value;
    
    // Determina la classe ossea per visualizzazione
    let densitaText = "";
    let densitaColor = "";
    if (hu > 1150) { densitaText = "D1 (Osso Duro)"; densitaColor = "#d63031"; } // Rosso
    else if (hu >= 850) { densitaText = "D2 (Osso Medio/Duro)"; densitaColor = "#e17055"; } // Arancio scuro
    else if (hu >= 400) { densitaText = "D3 (Osso Tenero)"; densitaColor = "#fdcb6e"; } // Giallo/Arancio
    else { densitaText = "D4 (Osso Molto Tenero)"; densitaColor = "#00b894"; } // Verde

    // --- QUI ANDR√Ä LA TUA LOGICA DAI PDF ---
    // Passiamo il parametro carico e dente alla funzione
    let protocollo = calcolaProtocollo(tipo, diametro, hu, carico, dente);
    
    // BADGE DEDOTTO
    let deducedBadge = "";
    if (protocollo.isDeduced) {
        deducedBadge = `<span class="badge-deduced">‚ö†Ô∏è PROTOCOLLO DEDOTTO</span>`;
    }

    html += `
      <div class="result-row" style="display: grid; grid-template-columns: 1fr 1px 1fr; gap: 20px; align-items:start;">
         <div>
            <div class="dente">Dente ${dente}</div>
            <div class="densita" style="color:${densitaColor}">${densitaText}</div>
            <div class="result-block"><strong>Impianto Selezionato:</strong> IDI ${tipo} √ò${diametro} L${lungh}</div>
            <div class="result-block"><strong>Carico Immediato:</strong> ${carico.toUpperCase()}</div>
            <hr style="border:0; border-top:1px solid #ddd; margin:10px 0;">
            <div class="result-block" style="background:white; padding:10px; border-radius:5px; border:1px solid #eee;">
               ${deducedBadge}
               <br><strong>SEQUENZA FRESE CONSIGLIATA:</strong><br><br>
               ${protocollo.fresa}
            </div>
            <div class="result-block"><strong>Note Cliniche:</strong><br> ${protocollo.note}</div>
         </div>
         
         <div style="background:#ccc; height:100%;"></div>
         
         <div style="text-align:center;">
            <!-- Placeholder Immagine -->
            <div class="img-placeholder">
               <span style="font-size:30px;">ü¶∑</span>
               <strong>${tipo} √ò${diametro}</strong>
               <p style="font-size:11px; margin-top:5px;">Immagine di riferimento</p>
            </div>
            <button onclick="openTechModal('${tipo}', '${diametro}')" style="margin-top:10px; background:#008080; color:white; font-size:12px; padding:5px;">
               üìÑ Scheda Tecnica ${tipo}
            </button>
         </div>
      </div>
    `;
  }
  
  document.getElementById('output').innerHTML = html;
  document.getElementById('output').scrollIntoView({behavior:'smooth'});
}

// Funzione helper per identificare l'arcata
function getArcata(dente) {
    // Quadranti 1 e 2 sono Mascella (Superiore)
    // Quadranti 3 e 4 sono Mandibola (Inferiore)
    const quadrante = Math.floor(parseInt(dente) / 10);
    if (quadrante === 1 || quadrante === 2) return 'mascella';
    if (quadrante === 3 || quadrante === 4) return 'mandibola';
    return null;
}

// --- FUNZIONE CUORE (LOGICA AGGIORNATA DA PDF) ---
function calcolaProtocollo(tipo, diametro, hu, carico, dente) {
  // Start comune aggiornato con Fresa Lettore
  let sequenza = "Start: Fresa Lanceolata &rarr; Fresa √ò2.3 &rarr; Py 3.0 &rarr; <strong style='color:#8e44ad;'>Fresa Lettore</strong>";
  let note = "";
  let isDeduced = false;
  
  // Identifica Arcata
  const arcata = getArcata(dente); // 'mascella' o 'mandibola'

  // ===================== LOGICA STONE =====================
  if (tipo === 'Stone') {
      
      // LOGICA DEDOTTA PER CARICO IMMEDIATO STONE
      if (carico === 'si') {
          isDeduced = true; // Flag Dedotto Attivo
          let warningCarico = "<br><br><strong style='color:#e67e22; background:#fff3e0; padding:2px;'>‚ö° PROTOCOLLO DEDOTTO PER CARICO IMMEDIATO:</strong> Sottopreparazione e Omissione Maschiatura per massimizzare il torque (>35 Ncm).";
          
          if (diametro === '3.5') {
              if (hu < 400) note = "<strong style='color:red;'>‚ö†Ô∏è SCONSIGLIATO IN D4:</strong> Stone 3.5 non indicato in osso D4 per carico immediato.";
              else if (hu < 850) { sequenza += " &rarr; Fermarsi alla Fresa √ò 2.8 (No T 3.5)"; note = "Sottopreparazione marcata (stop a 2.8) per stabilit√† in D3." + warningCarico; }
              else if (hu < 1150) { sequenza += " &rarr; Fresa √ò 3.0 (No T 3.5)"; note = "Stop a 3.0 per frizione in D2." + warningCarico; }
              else { sequenza += " &rarr; Fresa √ò 3.0 &rarr; T 3.5 (NO Maschiatore)"; note = "Preparazione standard D1 ma <strong>SENZA Maschiatura</strong>." + warningCarico; }
          }
          else if (['3.75', '4.0'].includes(diametro)) {
              if (hu < 400) { sequenza += " &rarr; Fermarsi alla Fresa √ò 3.0"; note = "Stop a 3.0 per cercare stabilit√† in D4 (valutare Stone 4.0)." + warningCarico; }
              else if (hu < 850) { sequenza += " &rarr; Fresa √ò 3.0 (No T 4.0)"; note = "Sottopreparazione D3." + warningCarico; }
              else if (hu < 1150) { sequenza += " &rarr; Fresa √ò 3.2 (No T 4.0)"; note = "Sottopreparazione D2." + warningCarico; }
              else { sequenza += " &rarr; Fresa √ò 3.4 &rarr; T 4.0 (NO Maschiatore)"; note = "Preparazione D1 standard ma <strong>SENZA Maschiatura</strong>." + warningCarico; }
          }
          else if (diametro === '5.0') {
              if (hu < 400) { sequenza += " &rarr; Fresa √ò 3.4 (Stop anticipato)"; note = "Stop anticipato a 3.4 per stabilit√† in D4." + warningCarico; }
              else if (hu < 850) { sequenza += " &rarr; Fresa √ò 3.8 &rarr; Fresa √ò 4.0 (No T 5.0)"; note = "Sottopreparazione D3." + warningCarico; }
              else { sequenza += " &rarr; Py 4.8 &rarr; Fresa √ò 4.8 &rarr; T 5.0 (NO Maschiatore)"; note = "Uso Stone 5.0 in D1/D2 senza maschiatura (invece di switch Aries)." + warningCarico; }
          }
          else { // √ò 6.0
              sequenza += " &rarr; Protocollo Stone 5.0 + Fresa √ò 5.3 (Stimato)";
              note = "Protocollo dedotto per √ò 6.0 immediato." + warningCarico;
          }
          return { fresa: sequenza, note: note, isDeduced: true };
      }

      // --- LOGICA STONE CARICO DIFFERITO (STANDARD) ---
      
      // Controllo Stone 6.0 (DEDOTTO anche in Differito)
      if (diametro === '6.0') {
          isDeduced = true; // Dedotto
          sequenza = "Start &rarr; ... Protocollo Stone 5.0 ... &rarr; Fresa √ò 5.3 (Stimato)";
          note = "Protocollo dedotto (estrapolato da √ò 5.0). Valutare densit√†.";
          return { fresa: sequenza, note: note, isDeduced: true };
      }

      // ... (Logica Stone Differito Standard rimane invariata ma ritorna isDeduced: false) ...
      if (diametro === '3.5') {
          if (hu < 400) { // D4
              sequenza += "<br>&darr;<br><strong>Fresa T 3.5</strong>";
              note = "<strong style='color:red;'>‚ö†Ô∏è SCONSIGLIATO IN D4:</strong> Il protocollo indica 'Sconsigliato' per Stone √ò 3.5 in osso D4.";
          } else if (hu < 850) { // D3
              sequenza += "<br>&darr;<br>Fresa √ò 2.8<br>&darr;<br><strong>Fresa T 3.5</strong>";
              note = "Protocollo D3 per Stone √ò 3.5.";
          } else if (hu < 1150) { // D2
              sequenza += "<br>&darr;<br>Fresa √ò 3.0<br>&darr;<br><strong>Fresa T 3.5</strong>";
              note = "Protocollo D2 per Stone √ò 3.5.";
          } else { // D1
              sequenza += "<br>&darr;<br>Fresa √ò 3.0<br>&darr;<br>Fresa T 3.5<br>&darr;<br><strong>Maschiatore M 3.4</strong>";
              note = "Protocollo D1 per Stone √ò 3.5. <strong>Obbligatorio Maschiatore</strong>.";
          }
      }
      else if (['3.75', '4.0'].includes(diametro)) {
          if (hu < 400) { // D4
              sequenza += "<br>&darr;<br><strong>Fresa T 4.0</strong>";
              if (diametro === '3.75') note = "‚ö†Ô∏è <strong>Attenzione D4:</strong> Consigliato Stone √ò 4.0.";
              else note = "Protocollo D4 ottimale per Stone √ò 4.0.";
          }
          else if (hu < 850) { // D3
              sequenza += "<br>&darr;<br>Fresa √ò 3.0<br>&darr;<br><strong>Fresa T 4.0</strong>";
              note = "Protocollo standard per Stone √ò 3.75/4.0 in D3.";
          }
          else if (hu < 1150) { // D2
              sequenza += "<br>&darr;<br>Fresa √ò 3.2<br>&darr;<br><strong>Fresa T 4.0</strong>";
              note = "Protocollo standard per Stone √ò 3.75/4.0 in D2.";
          }
          else { // D1
              sequenza += "<br>&darr;<br>Fresa √ò 3.4<br>&darr;<br>Fresa T 4.0<br>&darr;<br><strong>Maschiatore M 3.6</strong>";
              note = "Protocollo D1. <strong>Obbligatorio Maschiatore</strong>.";
          }
      }
      else if (diametro === '5.0') {
          if (hu < 400) { // D4
              sequenza += "<br>&darr;<br>Fresa √ò 3.4<br>&darr;<br>Py 3.8<br>&darr;<br>Fresa √ò 3.8<br>&darr;<br><strong>Fresa T 5.0</strong>";
              note = "Protocollo Stone √ò 5.0 in D4.";
          }
          else if (hu < 850) { // D3
              sequenza += "<br>&darr;<br>Fresa √ò 3.4<br>&darr;<br>Py 3.8<br>&darr;<br>Fresa √ò 4.0<br>&darr;<br>Fresa T 5.0<br>&darr;<br><strong>Maschiatore M 4.3</strong>";
              note = "Protocollo Stone √ò 5.0 in D3. Prevede maschiatura M 4.3.";
          }
          else if (hu < 1150) { // D2
              sequenza += "<br>&darr;<br>Py 3.8<br>&darr;<br>Py 4.8<br>&darr;<br>Fresa √ò 4.8<br>&darr;<br><strong>Fresa T 5.0</strong>";
              note = "‚ö†Ô∏è <strong>Attenzione D2:</strong> In osso D2 il protocollo consiglia di virare su <strong>Aries √ò 5.0</strong> per una gestione migliore della densit√†.";
          }
          else { // D1
              sequenza += "<br>&darr;<br>Py 3.8<br>&darr;<br>Py 4.8<br>&darr;<br>Fresa √ò 4.8<br>&darr;<br>Fresa T 5.0<br>&darr;<br><strong>Maschiatore M 5.0</strong>";
              note = "‚ö†Ô∏è <strong>Attenzione D1:</strong> In osso D1 il protocollo consiglia di virare su <strong>Aries √ò 5.0</strong> con maschiatura.";
          }
      }
  } 
  
  // ===================== LOGICA TIGER 2 =====================
  else if (tipo === 'Tiger2') {
     
     // --- LOGICA TIGER 2 √ò 3.8 ---
     if (diametro === '3.8') {
         if (carico === 'si') {
            isDeduced = true; // DEDOTTO
            let warningCarico = "<br><br><strong style='color:#e67e22; background:#fff3e0; padding:2px;'>‚ö° PROTOCOLLO DEDOTTO PER CARICO IMMEDIATO:</strong> Sottopreparazione per massimizzare il torque.";
            if (hu < 400) { // D4
                 sequenza = "Start &rarr; Pilot √ò2.0 &rarr; Fresa √ò2.3";
                 if (arcata === 'mascella') sequenza += " &rarr; <strong>Testa √ò 3.5</strong>";
                 else sequenza += " &rarr; <strong>Testa √ò 4.0</strong>";
                 note = "Protocollo D4 per Tiger 3.8 Carico Immediato. Sottopreparazione per stabilit√†." + warningCarico;
            } else { // D3-D1
                 sequenza = "Start &rarr; Pilot √ò2.0 &rarr; Fresa √ò2.3";
                 note = "‚ö†Ô∏è <strong>Attenzione (Carico Immediato):</strong> Il protocollo suggerisce di virare su <strong>Aries √ò 3.4</strong> per garantire stabilit√†.";
            }
         } 
         else {
             // Carico Differito (Standard)
             sequenza = "Start &rarr; Pilot √ò2.0 &rarr; Fresa √ò2.3";
             if (hu >= 1150) { // D1
                 sequenza += " &rarr; Fresa √ò3.0"; 
                 if (arcata === 'mascella') { sequenza += " &rarr; Fresa √ò3.2 &rarr; <strong>Testa √ò 4.0</strong>"; note = "Protocollo D1 Mascella."; }
                 else { sequenza += " &rarr; Fresa √ò3.4 &rarr; <strong>Testa √ò 4.0</strong>"; note = "Protocollo D1 Mandibola."; }
             } else if (hu >= 850) { // D2
                 sequenza += " &rarr; Fresa √ò2.8"; 
                 if (arcata === 'mascella') { sequenza += " &rarr; Fresa √ò3.0 &rarr; <strong>Testa √ò 4.0</strong>"; note = "Protocollo D2 Mascella."; }
                 else { sequenza += " &rarr; Fresa √ò3.2 &rarr; <strong>Testa √ò 4.0</strong>"; note = "Protocollo D2 Mandibola."; }
             } else if (hu >= 400) { // D3
                 if (arcata === 'mascella') { sequenza += " &rarr; Fresa √ò2.8 &rarr; <strong>Testa √ò 3.7</strong>"; note = "Protocollo D3 Mascella."; }
                 else { sequenza += " &rarr; Fresa √ò3.0 &rarr; <strong>Testa √ò 4.0</strong>"; note = "Protocollo D3 Mandibola."; }
             } else { // D4
                 if (arcata === 'mascella') { sequenza += " &rarr; <strong>Testa √ò 3.5</strong>"; note = "Protocollo D4 Mascella."; }
                 else { sequenza += " &rarr; <strong>Testa √ò 4.0</strong>"; note = "Protocollo D4 Mandibola."; }
             }
         }
     }

     // --- LOGICA TIGER 2 √ò 4.3 ---
     else if (diametro === '4.3') {
        if (carico === 'si') {
            // Questo NON √® dedotto, ho la scheda!
            isDeduced = false;
            if (hu < 400) { // D4
                 sequenza = "Start &rarr; Pilot √ò2.0 &rarr; Fresa √ò2.3"; // Re-initialize start for Tiger
                 sequenza += "<br>&darr;<br>Fresa √ò 3.0<br>&darr;<br><strong>Fresa T 4.3</strong>";
                 note = "Protocollo D4 per Tiger 4.3 Carico Immediato.";
            } else { // D3-D1
                 sequenza = "Start &rarr; Pilot √ò2.0 &rarr; Fresa √ò2.3"; // Re-initialize start for Tiger
                 sequenza += "<br>&darr;<br>Fresa √ò 3.0/3.2/3.4";
                 note = "‚ö†Ô∏è <strong>Attenzione (Carico Immediato):</strong> In osso > D4 il protocollo suggerisce di virare su <strong>Aries √ò 3.75</strong>.";
            }
        } else {
            // Carico Differito (Standard)
            sequenza = "Start &rarr; Pilot √ò2.0 &rarr; Fresa √ò2.3";
            if (hu < 400) { // D4
                if (arcata === 'mascella') { sequenza += " &rarr; <strong>Testa √ò 4.0</strong>"; note = "Protocollo D4 Mascella."; }
                else { sequenza += " &rarr; Fresa √ò 2.8 &rarr; <strong>Testa √ò 4.3</strong>"; note = "Protocollo D4 Mandibola."; }
            } else if (hu < 850) { // D3
                if (arcata === 'mascella') { sequenza += " &rarr; Fresa √ò 3.0 &rarr; <strong>Testa √ò 4.0</strong>"; note = "Protocollo D3 Mascella."; }
                else { sequenza += " &rarr; Fresa √ò 3.2 &rarr; <strong>Testa √ò 4.3</strong>"; note = "Protocollo D3 Mandibola."; }
            } else if (hu < 1150) { // D2
                sequenza += " &rarr; Fresa √ò 2.8";
                if (arcata === 'mascella') { sequenza += " &rarr; Fresa √ò 3.4 &rarr; <strong>Testa √ò 4.3</strong>"; note = "Protocollo D2 Mascella."; }
                else { sequenza += " &rarr; Fresa √ò 3.6 &rarr; <strong>Testa √ò 4.3</strong>"; note = "Protocollo D2 Mandibola."; }
            } else { // D1
                sequenza += " &rarr; Fresa √ò 3.0";
                if (arcata === 'mascella') { sequenza += " &rarr; Fresa √ò 4.2 &rarr; <strong>Testa √ò 4.3</strong>"; note = "Protocollo D1 Mascella. <strong style='color:red'>Sconsigliato</strong>."; }
                else { sequenza += " &rarr; Fresa √ò 4.2 &rarr; <strong>Testa √ò 4.3</strong>"; note = "Protocollo D1 Mandibola. <strong style='color:red'>Sconsigliato</strong>."; }
            }
        }
     } 

     // --- LOGICA TIGER 2 √ò 4.8 ---
     else if (diametro === '4.8') {
         if (carico === 'si') {
             isDeduced = true; // DEDOTTO
             let warningCarico = "<br><br><strong style='color:#e67e22; background:#fff3e0; padding:2px;'>‚ö° PROTOCOLLO DEDOTTO PER CARICO IMMEDIATO:</strong> Sottopreparazione per massimizzare il torque.";
             if (hu < 400) { // D4
                 sequenza = "Start &rarr; Pilot 2.0 &rarr; Fresa 2.3 &rarr; Fresa 3.0";
                 if (arcata === 'mascella') sequenza += " &rarr; <strong>Testa 4.3</strong>";
                 else sequenza += " &rarr; <strong>Testa 4.8</strong>";
                 note = "Protocollo D4 Immediato (Dedotto): Sottopreparazione." + warningCarico;
             } else {
                 sequenza = "Start &rarr; Pilot 2.0 &rarr; ...";
                 note = "‚ö†Ô∏è <strong>Attenzione (Carico Immediato):</strong> In osso denso, considerare switch ad Aries o sottopreparazione marcata.";
             }
         }
         else {
             // Carico Differito (Standard)
             sequenza = "Start &rarr; Pilot 2.0 &rarr; Fresa 2.3";
             if (hu < 400) { // D4
                 if (arcata === 'mascella') { sequenza += " &rarr; Fresa 3.0 &rarr; <strong>Testa 4.3</strong>"; note = "Protocollo D4 Mascella."; }
                 else { sequenza += " &rarr; Fresa 3.0 &rarr; Fresa 3.2 &rarr; <strong>Testa 4.8</strong>"; note = "Protocollo D4 Mandibola."; }
             } else if (hu < 850) { // D3
                 if (arcata === 'mascella') { sequenza += " &rarr; Fresa 3.0 &rarr; Fresa 3.4 &rarr; <strong>Testa 4.8</strong>"; note = "Protocollo D3 Mascella."; }
                 else { sequenza += " &rarr; Fresa 3.0 &rarr; Fresa 3.6 &rarr; <strong>Testa 4.8</strong>"; note = "Protocollo D3 Mandibola."; }
             } else if (hu < 1150) { // D2
                 if (arcata === 'mascella') { sequenza += " &rarr; Fresa 3.2 &rarr; Fresa 4.0 &rarr; <strong>Testa 4.8</strong>"; note = "Protocollo D2 Mascella."; }
                 else { sequenza += " &rarr; Fresa 3.2 &rarr; Fresa 4.2 &rarr; <strong>Testa 4.8</strong>"; note = "Protocollo D2 Mandibola."; }
             } else { // D1
                 sequenza += " &rarr; Fresa 3.4 &rarr; Fresa 4.6 &rarr; <strong>Testa 4.8</strong>";
                 note = "<strong style='color:red'>Sconsigliato in D1.</strong>";
             }
         }
     }

     // --- LOGICA TIGER 2 √ò 5.3 ---
     else if (diametro === '5.3') {
         if (carico === 'si') {
             isDeduced = true; // DEDOTTO
             let warningCarico = "<br><br><strong style='color:#e67e22; background:#fff3e0; padding:2px;'>‚ö° PROTOCOLLO DEDOTTO PER CARICO IMMEDIATO:</strong> Sottopreparazione per massimizzare il torque.";
             if (hu < 400) {
                 sequenza = "Start &rarr; Pilot 2.0 &rarr; Fresa 2.3 &rarr; Fresa 3.4";
                 if (arcata === 'mascella') sequenza += " &rarr; <strong>Testa 4.8</strong>";
                 else sequenza += " &rarr; <strong>Testa 5.3</strong>";
                 note = "Protocollo D4 Immediato (Dedotto): Sottopreparazione." + warningCarico;
             } else {
                 sequenza = "Start &rarr; ...";
                 note = "‚ö†Ô∏è <strong>Attenzione (Carico Immediato):</strong> Considerare switch ad Aries o sottopreparazione.";
             }
         }
         else {
             // Carico Differito (Standard)
             sequenza = "Start &rarr; Pilot 2.0 &rarr; Fresa 2.3";
             if (hu < 400) { // D4
                 if (arcata === 'mascella') { sequenza += " &rarr; Fresa 3.4 &rarr; <strong>Testa 4.8</strong>"; note = "Protocollo D4 Mascella."; }
                 else { sequenza += " &rarr; Fresa 3.4 &rarr; <strong>Testa 5.3</strong>"; note = "Protocollo D4 Mandibola."; }
             } else if (hu < 850) { // D3
                 if (arcata === 'mascella') { sequenza += " &rarr; Fresa 3.4 &rarr; Fresa 3.6 &rarr; <strong>Testa 5.3</strong>"; note = "Protocollo D3 Mascella."; }
                 else { sequenza += " &rarr; Fresa 3.4 &rarr; Fresa 3.8 &rarr; <strong>Testa 5.3</strong>"; note = "Protocollo D3 Mandibola."; }
             } else if (hu < 1150) { // D2
                 if (arcata === 'mascella') { sequenza += " &rarr; Fresa 3.6 &rarr; Fresa 4.0 &rarr; <strong>Testa 5.3</strong>"; note = "Protocollo D2 Mascella."; }
                 else { sequenza += " &rarr; Fresa 3.6 &rarr; Fresa 4.2 &rarr; <strong>Testa 5.3</strong>"; note = "Protocollo D2 Mandibola."; }
             } else { // D1
                 sequenza += " &rarr; Fresa 3.8 &rarr; Fresa 5.0 &rarr; <strong>Testa 5.3</strong>";
                 note = "<strong style='color:red'>Sconsigliato in D1.</strong>";
             }
         }
     }
  } 
  
  return { fresa: sequenza, note: note, isDeduced: isDeduced };
}
</script>
</body>
</html>